{% extends 'base.html' %}
{% load static %}

{% block title %}Book Room - {{ room.room_type }}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/booking-form.css' %}">
{% endblock head %}

{% block content %}
<div class="booking-page">
    <h2>Book Room: {{ room.room_type }}</h2>
    
    <div class="room-info">
        <h3>Room Details</h3>
        <p><strong>Type:</strong> {{ room.room_type }}</p>
        <p><strong>Price:</strong> ${{ room.price_per_night }}/night</p>
        <p><strong>Hotel:</strong> {{ room.hotel_id.first_name }}</p>
    </div>
    
    <form method="post">
        {% csrf_token %}
        
        <div class="dates-row">
            <div class="date-field">
                <label>{{ form.check_in_date.label }}</label>
                {{ form.check_in_date }}
            </div>
            <div class="date-field">
                <label>{{ form.check_out_date.label }}</label>
                {{ form.check_out_date }}
            </div>
        </div>
        
        <div class="services-section">
            <label>Services</label>
            {{ form.services }}
        </div>
        
        <div class="price-section">
            <h3>Price Breakdown</h3>
            <div class="price-details">
                <p><strong>Room:</strong> ${{ room.price_per_night }} per night</p>
                <p><strong>Total nights:</strong> <span class="nights-count">-</span></p>
                <p><strong>Room total:</strong> $<span class="room-total">0</span></p>
                <p><strong>Services total:</strong> $<span class="services-total">0</span></p>
                <hr>
                <p><strong>Grand Total:</strong> $<span class="grand-total">0</span></p>
            </div>
        </div>
        
        <div class="buttons">
            <button type="submit">Book Now</button>
            <a href="{% url 'homepage' %}">Cancel</a>
        </div>
    </form>
</div>

<script>
//calculation function
document.addEventListener('DOMContentLoaded', function() {
    const checkInInput = document.getElementById('{{ form.check_in_date.id_for_label }}');
    const checkOutInput = document.getElementById('{{ form.check_out_date.id_for_label }}');
    const serviceCheckboxes = document.querySelectorAll('input[name="services"]');
    const roomPricePerNight = {{ room.price_per_night }};
    
    const servicePrices = {
        {% for service in services %}
        {{ service.id }}: {{ service.price }},
        {% endfor %}
    };
    
    function calculatePrice() {
        const checkIn = checkInInput.value;
        const checkOut = checkOutInput.value;
        
        if (checkIn && checkOut && checkOut > checkIn) {
            const checkInDate = new Date(checkIn);
            const checkOutDate = new Date(checkOut);
            const timeDiff = checkOutDate.getTime() - checkInDate.getTime();
            const nights = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            const roomTotal = roomPricePerNight * nights;
            
            let servicesTotal = 0;
            serviceCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    servicesTotal += servicePrices[checkbox.value] || 0;
                }
            });
            
            const grandTotal = roomTotal + servicesTotal;
            
            document.querySelector('.nights-count').textContent = nights;
            document.querySelector('.room-total').textContent = roomTotal.toFixed(2);
            document.querySelector('.services-total').textContent = servicesTotal.toFixed(2);
            document.querySelector('.grand-total').textContent = grandTotal.toFixed(2);
        } else {
            document.querySelector('.nights-count').textContent = '-';
            document.querySelector('.room-total').textContent = '0';
            document.querySelector('.services-total').textContent = '0';
            document.querySelector('.grand-total').textContent = '0';
        }
    }
    
    checkInInput.addEventListener('change', function() {
        if (this.value) {
            const checkInDate = new Date(this.value);
            const nextDay = new Date(checkInDate);
            nextDay.setDate(nextDay.getDate() + 1);
            checkOutInput.min = nextDay.toISOString().split('T')[0];
        }
        calculatePrice();
    });
    
    checkOutInput.addEventListener('change', calculatePrice);
    
    serviceCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', calculatePrice);
    });
    
    calculatePrice();
});
</script>

{% endblock content %}

